name: Deploy Backend

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'cmd/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o linkbridge-backend ./cmd/api

      - name: Deploy
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/key
          chmod 600 ~/.ssh/key

          # SSH config for slow connections
          cat >> ~/.ssh/config << EOF
          Host deploy
            HostName $SERVER_HOST
            User $SERVER_USER
            IdentityFile ~/.ssh/key
            StrictHostKeyChecking no
            ConnectTimeout 120
            ServerAliveInterval 30
            ServerAliveCountMax 5
          EOF

          # Upload with retry
          for i in 1 2 3; do
            echo "Upload attempt $i..."
            scp -F ~/.ssh/config linkbridge-backend deploy:/tmp/linkbridge-backend && break
            sleep 10
          done

          # Deploy
          ssh -F ~/.ssh/config deploy << 'DEPLOY'
          set -e
          systemctl stop linkbridge || true
          mv /tmp/linkbridge-backend /opt/linkbridge-backend
          chmod +x /opt/linkbridge-backend
          systemctl start linkbridge
          sleep 2
          systemctl status linkbridge --no-pager
          DEPLOY
